---

# Base cldr-runner

version: 1

build_arg_defaults:
  EE_BASE_IMAGE: "quay.io/ansible/ansible-runner:stable-2.12-latest"
  EE_BUILDER_IMAGE: "ghcr.io/cloudera-labs/ansible-builder:latest"

dependencies:
  galaxy: galaxy.yml
  python: requirements.txt
  system: bindep.txt

additional_build_steps:
  prepend: |
    ARG BUILD_VER="latest"
    ENV CLDR_BUILD_VER=$BUILD_VER
    ENV PKGMGR_OPTS="--nodocs --setopt install_weak_deps=0"
    COPY . /tmp/src
    RUN mv /tmp/src/bashrc /home/runner/.bashrc && \
        mv /tmp/src/repo/*.repo /etc/yum.repos.d/ && \
        mv /tmp/src/env /tmp/src/inventory /runner && \
        dnf clean all && \
        /usr/bin/python3 -m pip install --upgrade pip && \
        /usr/bin/python3 -m pip cache purge
  append: |
    RUN alternatives --set python /usr/bin/python3 && \
        pip cache purge || echo "No Pip cache to purge" && \
        dnf clean all -y && \
        rm -rf /var/cache/yum && \
        rm -rf /var/cache/dnf && \
        rm -rf /tmp/src
